# Crate Minimum Requirements and DX (v1‑draft)

This document defines the minimum requirements for each crate to ensure seamless development (DX), testability, provenance, and publishability. Every crate is treated as a product with its own docs, specs, implementation plan, bugs, tests, testing artifacts, and provenance manifest.

Related: `./18_workspace.md`, `./20_testing_and_tiers.md`.

---

## 0. Canonical crate layout (must‑have)

```
crates/<name>/
├── src/                          # source code
├── tests/                        # integration tests
├── README.md                     # crate overview and usage
├── CHANGELOG.md                  # versioned changes (semver)
├── .provenance/
│   ├── manifest.json             # crate‑scoped manifest (see §4)
│   └── manifest.json.sig         # Ed25519 signature (Base64)
├── ci/
│   ├── front_page.pml            # crate Proofdown front page (human review)
│   ├── tests/summary.json        # generated by crate tests (if applicable)
│   ├── coverage/coverage.json    # generated by coverage (if applicable)
│   └── tests/failures.md         # optional details
└── .specs/
    ├── 00_goals.md               # goals/scope (what the crate does)
    ├── 01_plan.md                # implementation plan and milestones
    ├── 02_api.md                 # public API (library) or CLI (binary)
    └── 03_testing.md             # test plan and fixtures mapping
```

Notes
- The top‑level `features/*.feature` cover cross‑crate behaviors. Crates may also include crate‑local Gherkin features under `crates/<name>/features/`.
- The root SSG can be pointed at `crates/<name>` to build crate sites.

---

## 1. Cargo metadata (DX & publishability)

Each crate’s `Cargo.toml` MUST include:
- `[package]`
  - `name`, `version`, `edition`, `license` (or `license.workspace = true`)
  - `description`, `repository`, `homepage` (optional), `documentation` (optional)
  - `readme = "README.md"`, `keywords`, `categories` (if publishing)
  - `rust-version` (MSRV if required)
- `[features]` (if any): clear, minimal; default feature set deterministic
- `[dev-dependencies]` for test tooling only

---

## 2. Testing (crate level)

- Unit tests in `src/` and integration tests in `tests/` with focused assertions.
- Golden tests for deterministic outputs (when applicable) under `tests/golden/`.
- Optional crate‑local Gherkin features under `crates/<name>/features/`.
- Provenance artifacts generation (summary/coverage/failures) documented in `.specs/03_testing.md`.
- Command to build crate site for human review:
  - `cargo run -p provenance_ssg -- --root crates/<name> --out crates/<name>/site --verify-manifest`

---

## 3. Provenance (crate‑scoped)

- `.provenance/manifest.json` lists crate artifacts and front page; `.sig` signs canonical bytes (Ed25519 Base64).
- `ci/front_page.pml` renders KPIs and viewers for crate artifacts.
- Artifacts referenced by the manifest MUST be produced by the crate’s tests/CI.
- Crate README SHOULD include badges referencing the crate site’s badges.

---

## 4. Crate manifest minimum (v1)

- Required fields: `version`, `repo`, `commit`, `workflow_run`, `front_page.title`, `front_page.markup`, `artifacts[]`.
- Each artifact: `id`, `title`, `path`, `media_type`, `render`, `sha256`.
- Validation: schema `schemas/manifest.schema.json`; canonicalization per `.specs/03_canonicalization.md`.
- Signing: `.specs/04_signing.md` (Ed25519 Base64 over canonical bytes).

---

## 5. Readiness tier mapping (per crate)

- Pre‑Alpha
  - Compiles; fmt/clippy pass; README exists; `.provenance/manifest.json` stub and `ci/front_page.pml` stub exist; at least one unit test.
- Alpha
  - Minimal features implemented; manifest validates; canonicalization produces stable bytes; signed manifest present; crate site builds.
- Beta
  - Full minimal features for the crate; deterministic outputs; error handling; basic a11y smoke.
- Release Candidate
  - Full spec compliance; security tests pass; crate docs complete (README + specs); golden tests in place.
- Release Ready
  - Version pinned; CHANGELOG updated; reproducible CI builds; all artifacts produced by CI.
- Publish Ready
  - `cargo publish --dry-run` succeeds (for libs); binary crates document install flow; badges wired.
- Production Ready
  - Security review; SLOs and maintenance plan; provenance artifacts routinely updated in CI.

---

## 6. Per‑crate minimums (v1)

- `provenance_ssg` (bin)
  - Minimal: read manifest; verify sha256; render index and per‑artifact pages; viewers: markdown/json/image/summary:test/table:coverage; robots.txt
  - Next: parse front_page.pml; truncation banners; deterministic outputs; static badges
- `manifest_contract` (lib)
  - Minimal: types; load/parse; basic validation errors
  - Next: schema validation; canonicalization; Ed25519 verification helper
- `proofdown_parser` (lib)
  - Minimal: parse structural components and artifact.*; link macro; unknowns error
  - Next: include depth/cycle; bounds; minimal AST tests
- `renderers` (lib)
  - Minimal: pure RSX/HTML for markdown/json/coverage/summary/image; structural layout
  - Next: sanitization, golden outputs, a11y table structure
- `badges` (lib)
  - Minimal: compute JSON badges (provenance/tests/coverage)
  - Next: minimal SVGs; thresholds; error badges on missing/invalid artifacts

---

## 7. DX checklist (every crate)

- README with:
  - Scope, quick start, API/CLI usage, examples, links to `.specs` and `.provenance`.
- Specs directory with:
  - `00_goals.md`, `01_plan.md`, `02_api.md`, `03_testing.md` (kept brief and actionable)
- Testing:
  - `cargo test` green; one golden test (if applicable). Optional `features/` BDD.
- Provenance:
  - `ci/front_page.pml` renders KPIs and links; manifest + signature present and valid.
- Publishing hygiene:
  - Cargo metadata filled; semver; CHANGELOG entry; `cargo publish --dry-run` (libs only).

---

## 8. Templates

See `templates/crate/*` for starter files (README, manifest, front_page.pml, specs).
